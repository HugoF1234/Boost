{% extends "base.html" %}
{% block content %}

<!-- Section titre avec métriques améliorées -->
<div class="welcome-section fade-in">
<div class="welcome-content">
<div>
            <h1 class="greeting">Bienvenue, {{ first_name }}</h1>
<p class="greeting-subtitle">{{ name }} | {{ email }}</p>
</div>
        {% if article_success %}
        <div class="success-badge">
<i class="fas fa-check-circle"></i>
            Article sélectionné avec succès !
        </div>
        {% endif %}
    </div>
    
    <!-- Métriques redessinées -->
    <div class="dashboard-metrics">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-clock"></i>
</div>
            <div class="metric-content">
                <span class="metric-number">{{ scheduled_posts }}</span>
                <span class="metric-label">En attente</span>
</div>
</div>
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-edit"></i>
            </div>
            <div class="metric-content">
                <span class="metric-number">{{ posts|length if posts else 0 }}</span>
                <span class="metric-label">Total posts</span>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
                <span class="metric-number">100%</span>
                <span class="metric-label">Succès</span>
            </div>
        </div>
</div>
</div>

<!-- Section pour l'article sélectionné -->
{% if selected_article %}
<div class="creation-section fade-in">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-feather-alt icon-noble"></i>
            Créer à partir de votre article
        </h2>
<p class="section-subtitle">Transformons cette actualité en contenu engageant qui reflète votre expertise</p>
</div>
<div class="selected-article">
<h3 class="article-title">{{ selected_article.title|clean_html }}</h3>
<p class="article-description">{{ selected_article.description|clean_html }}</p>
<div class="article-meta">
<div>
<i class="fas fa-globe icon-noble"></i>
<a href="{{ selected_article.url }}" style="color: var(--primary-coral); text-decoration: none; font-weight: 500;" target="_blank">
                    {{ selected_article.source.name }}
                </a>
</div>
<div>
<i class="fas fa-calendar icon-noble"></i>
                {{ selected_article.formatted_date }}
            </div>
</div>
</div>
<form method="post">
<div class="form-group">
<label class="form-label">
<i class="fas fa-magic icon-noble"></i>
                Instructions personnalisées (optionnel)
            </label>
<textarea class="form-control textarea-control" name="custom_instructions" placeholder="Partagez votre perspective unique sur ce sujet. Par exemple : 'En tant qu'expert en transformation digitale, j'aimerais mettre l'accent sur les défis d'adoption dans les PME...'"></textarea>
<div class="mention-tip">
<i class="fas fa-lightbulb icon-noble"></i>
<span>Personnalisez votre post avec vos propres instructions. Laissez vide pour utiliser les paramètres par défaut.</span>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Ton du post</label>
<select class="form-control" name="tone">
<option value="professionnel">Professionnel bienveillant</option>
<option value="familier">Conversationnel</option>
<option value="inspirant">Inspirant</option>
<option value="humoristique">Décontracté</option>
<option value="factuel">Pédagogique</option>
<option value="critique">Analytique</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Perspective</label>
<select class="form-control" name="perspective">
<option value="neutre">Neutre</option>
<option value="enthousiaste">Enthousiaste</option>
<option value="analytique">Analytique</option>
<option value="innovant">Innovateur</option>
<option value="expert">Expert du domaine</option>
</select>
</div>
<button class="btn btn-primary" name="generate_from_article" type="submit">
<i class="fas fa-magic"></i>
                Créer mon contenu
            </button>
</div>
</form>
<a class="btn btn-secondary" href="{{ url_for('dashboard', clear='true') }}" style="margin-top: 1rem;">
<i class="fas fa-times"></i>
        Annuler
    </a>
</div>
{% else %}
<!-- Section principale avec colonnes gauche/droite -->
<div class="creation-section fade-in">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-pen-fancy icon-noble"></i>
            Créer un nouveau post
        </h2>
        <p class="section-subtitle spaced-subtitle">Utilisez l'IA pour créer rapidement un contenu authentique et engageant pour votre audience LinkedIn</p>
</div>
    
<form method="post">
        <!-- Ligne 1 : Sujet du post -->
<div class="form-group">
            <label class="form-label">
                <i class="fas fa-comment-dots icon-noble"></i>
                Sujet de votre post
            </label>
            <input class="form-control" name="subject" type="text" placeholder="Ex: Partagez des conseils sur le leadership en temps de crise" required=""/>
</div>
        
        <!-- Ligne 2 : Ton + Advanced Settings + Bouton -->
        <div class="compact-controls">
            <div class="form-group tone-group">
                <label class="form-label">
                    <i class="fas fa-palette icon-noble"></i>
                    Ton du post
                </label>
<select class="form-control" name="tone">
<option value="professionnel">Professionnel bienveillant</option>
<option value="familier">Conversationnel</option>
<option value="inspirant">Inspirant</option>
<option value="humoristique">Décontracté</option>
<option value="factuel">Pédagogique</option>
                    <option value="critique">Analytique</option>
</select>
</div>
            
            <!-- Advanced Settings collapsible -->
            <div class="advanced-settings-compact">
                <label class="form-label">
                    <i class="fas fa-cog icon-noble"></i>
                    Paramètres avancés
                </label>
                <button type="button" class="settings-toggle" onclick="toggleAdvancedSettings()">
                    <i class="fas fa-cog"></i>
                    Advanced Settings
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </button>
                
                <!-- Backdrop pour l'overlay -->
                <div class="settings-backdrop" id="settingsBackdrop" onclick="closeAdvancedSettings()"></div>
                
                <div class="settings-panel" id="advancedPanel">
                    <div class="settings-panel-header">
                        <h3>Paramètres avancés</h3>
                        <button type="button" class="settings-close-btn" onclick="closeAdvancedSettings()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-magic icon-noble"></i>
                            Instructions personnalisées (optionnel)
                        </label>
                        <textarea class="form-control textarea-control" name="custom_instructions" placeholder="Partagez votre perspective unique sur ce sujet..." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-eye icon-noble"></i>
                            Perspective
                        </label>
                        <select class="form-control" name="perspective">
                            <option value="neutre">Neutre</option>
                            <option value="enthousiaste">Enthousiaste</option>
                            <option value="analytique">Analytique</option>
                            <option value="innovant">Innovateur</option>
                            <option value="expert">Expert du domaine</option>
                        </select>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div class="settings-panel-actions">
                        <button type="button" class="btn btn-secondary settings-cancel-btn" onclick="closeAdvancedSettings()">
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button type="button" class="btn btn-primary settings-ok-btn" onclick="saveAdvancedSettings()">
                            <i class="fas fa-check"></i>
                            OK
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="create-btn-wrapper">
                <label class="form-label">
                    <i class="fas fa-magic icon-noble"></i>
                    Action
                </label>
                <button class="btn btn-primary create-btn-compact" type="submit">
<i class="fas fa-magic"></i>
                Créer
            </button>
            </div>
</div>
</form>
    
    <!-- Bouton "Créer un post basé sur l'actualité" -->
    <div class="news-invitation-section">
<a class="news-invitation" href="{{ url_for('news_assistant') }}">
            <div class="invitation-content">
                <div class="invitation-title">
                    <i class="fas fa-newspaper icon-noble"></i>
                    Créer un post basé sur l'actualité
</div>
                <div class="invitation-subtitle">Inspirez-vous des sujets tendances de votre secteur</div>
</div>
            <i class="fas fa-arrow-right" style="font-size: 1.5rem; margin-left: auto;"></i>
</a>
    </div>
</div>
{% endif %}

{% if draft %}
<div class="generated-content fade-in">
<div class="section-header">
<h2 class="section-title">
<i class="fas fa-edit icon-noble"></i>
                    Votre contenu personnalisé
                </h2>
<p class="section-subtitle">Créé spécialement pour votre audience LinkedIn. Ajustez si nécessaire avant publication.</p>
</div>
<div class="linkedin-post">
<div class="post-header">
<div class="post-avatar">
                    {{ first_name[0]|upper }}{{ last_name[0]|upper if last_name else '' }}
            </div>
<div class="post-user-info">
<h4>{{ first_name }} {{ last_name }}</h4>
<p>{{ email }}</p>
</div>
</div>
<div class="post-content" id="post-preview">{{ draft|safe }}</div>
                </div>
<form method="post">
<div class="form-group">
<label class="form-label">
<i class="fas fa-edit icon-noble"></i>
                    Contenu de votre post
                </label>
<div class="mention-editor">
<textarea class="form-control textarea-control" id="content-editor" name="content" placeholder="Votre contenu LinkedIn..." required="">{{ draft }}</textarea>
<div class="mention-suggestions" id="mention-suggestions"></div>
</div>
<div class="mention-tip">
<i class="fas fa-at icon-noble"></i>
<span>Tapez @ pour mentionner quelqu'un dans votre post (ex: @nomdelapersonne)</span>
</div>
</div>
<div class="media-selection">
<div class="media-tabs">
<button class="media-tab active" data-tab="upload" type="button">
<i class="fas fa-upload"></i>
                        Télécharger
                </button>
<button class="media-tab" data-tab="pexels" type="button">
<i class="fas fa-images"></i>
                        Photos libres
                </button>
</div>
<div class="media-content active" id="upload-content">
<div class="upload-area" id="upload-area">
<div class="upload-icon">
<i class="fas fa-cloud-upload-alt"></i>
</div>
<div class="upload-text">Glissez-déposez vos fichiers ici ou cliquez pour sélectionner</div>
<div class="upload-hint">JPG, PNG, GIF jusqu'à 10MB</div>
<input accept="image/*" id="media-upload" name="media" style="display: none;" type="file"/>
</div>
</div>
<div class="media-content" id="pexels-content">
<div class="pexels-search">
<input class="pexels-input" id="pexels-query" placeholder="Rechercher des photos..." type="text"/>
<button class="pexels-btn" id="pexels-search-btn" type="button">Rechercher</button>
</div>
<div class="pexels-results" id="pexels-results"></div>
</div>
</div>
<div class="selected-media" id="selected-media" style="display: none;">
<div class="selected-media-title">Média sélectionné</div>
<div class="selected-media-preview" id="selected-media-preview"></div>
</div>
<input id="selected-media-input" name="selected_media" type="hidden"/>
<div class="publish-section">
<div class="publish-row">
<div class="datetime-group">
<label class="form-label" style="margin-bottom: 0;">Programmer (optionnel)</label>
<input class="datetime-input" name="publish_date" placeholder="Date" type="date"/>
<input class="datetime-input" name="publish_time" placeholder="Heure" type="time"/>
</div>
<div class="publish-buttons">
<button class="btn btn-secondary" name="save_draft" type="submit">
<i class="fas fa-save"></i>
                            Sauvegarder
                    </button>
<button class="btn btn-primary" name="publish" type="submit">
<i class="fab fa-linkedin"></i>
                            Publier maintenant
                    </button>
</div>
</div>
</div>
</form>
</div>
{% endif %}

<script>
// JavaScript pour gestion des médias
document.addEventListener('DOMContentLoaded', function() {
    // Sélection d'onglets
    const tabs = document.querySelectorAll('.media-tab');
    const contents = document.querySelectorAll('.media-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.dataset.tab;
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${target}-content`).classList.add('active');
        });
    });
    
    // Upload de fichiers
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('media-upload');
    
    if (uploadArea && fileInput) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelection(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });
    }
    
    function handleFileSelection(file) {
        const selectedMedia = document.getElementById('selected-media');
        const preview = document.getElementById('selected-media-preview');
        const input = document.getElementById('selected-media-input');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="selected-media-info">
                        <div class="selected-media-name">${file.name}</div>
                        <div class="selected-media-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <button type="button" class="remove-media" onclick="removeSelectedMedia()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                selectedMedia.style.display = 'block';
                input.value = `upload:${file.name}`;
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Pexels API
    const pexelsBtn = document.getElementById('pexels-search-btn');
    const pexelsQuery = document.getElementById('pexels-query');
    const pexelsResults = document.getElementById('pexels-results');
    
    if (pexelsBtn && pexelsQuery) {
        pexelsBtn.addEventListener('click', searchPexels);
        pexelsQuery.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchPexels();
            }
        });
    }
    
    function searchPexels() {
        const query = pexelsQuery.value.trim();
        if (!query) return;
        
        pexelsResults.innerHTML = '<div style="text-align: center; padding: 2rem;">Recherche en cours...</div>';
        
        fetch(`/search_pexels?query=${encodeURIComponent(query)}&per_page=12`)
            .then(response => response.json())
            .then(data => {
                if (data.photos && data.photos.length > 0) {
                    pexelsResults.innerHTML = '';
                    data.photos.forEach(photo => {
                        const div = document.createElement('div');
                        div.className = 'pexels-image';
                        div.innerHTML = `<img src="${photo.src.medium}" alt="${photo.alt}">`;
                        div.addEventListener('click', () => selectPexelsImage(photo));
                        pexelsResults.appendChild(div);
                    });
                } else {
                    pexelsResults.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-medium);">Aucune photo trouvée</div>';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                pexelsResults.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--error);">Erreur de recherche</div>';
            });
    }
    
    function selectPexelsImage(photo) {
        const selectedMedia = document.getElementById('selected-media');
        const preview = document.getElementById('selected-media-preview');
        const input = document.getElementById('selected-media-input');
        
        // Désélectionner les autres images
        document.querySelectorAll('.pexels-image').forEach(img => img.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        preview.innerHTML = `
            <img src="${photo.src.medium}" alt="${photo.alt}">
            <div class="selected-media-info">
                <div class="selected-media-name">Photo par ${photo.photographer}</div>
                <div class="selected-media-size">Pexels</div>
            </div>
            <button type="button" class="remove-media" onclick="removeSelectedMedia()">
                <i class="fas fa-times"></i>
            </button>
        `;
        selectedMedia.style.display = 'block';
        input.value = `pexels:${photo.id}:${photo.src.large}`;
    }
    
    // Mise à jour de l'aperçu du contenu
    const contentEditor = document.getElementById('content-editor');
    const postPreview = document.getElementById('post-preview');
    
    if (contentEditor && postPreview) {
        contentEditor.addEventListener('input', () => {
            let content = contentEditor.value;
            
            // Convertir les mentions
            content = content.replace(/@(\w+)/g, '<span style="color: var(--primary-purple); font-weight: 600;">@$1</span>');
            
            // Convertir les retours à la ligne
            content = content.replace(/\n/g, '<br>');
            
            postPreview.innerHTML = content;
        });
    }
    
    // Animation progressive des éléments avec délais
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach((el, index) => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
            setTimeout(() => {
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
            el.style.transition = 'all 0.6s ease';
        }, index * 200);
    });
    
    // Effet de parallaxe subtil pour les éléments décoratifs
    window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset;
        const sections = document.querySelectorAll('.welcome-section, .creation-section');
        
        sections.forEach(section => {
            const before = section.querySelector('::before');
            if (before) {
                section.style.transform = `translateY(${scrolled * 0.1}px)`;
            }
        });
    });
});

function removeSelectedMedia() {
    const selectedMedia = document.getElementById('selected-media');
    const input = document.getElementById('selected-media-input');
    selectedMedia.style.display = 'none';
    input.value = '';
    
    // Désélectionner l'image Pexels si applicable
    document.querySelectorAll('.pexels-image').forEach(img => img.classList.remove('selected'));
}

function toggleAdvancedSettings() {
    const panel = document.getElementById('advancedPanel');
    const backdrop = document.getElementById('settingsBackdrop');
    const toggleIcon = document.querySelector('.toggle-icon');
    
    console.log('Toggle Advanced Settings clicked');
    
    if (panel.classList.contains('expanded')) {
        closeAdvancedSettings();
    } else {
        openAdvancedSettings();
    }
}

function openAdvancedSettings() {
    const panel = document.getElementById('advancedPanel');
    const backdrop = document.getElementById('settingsBackdrop');
    const toggleIcon = document.querySelector('.toggle-icon');
    
    panel.classList.add('expanded');
    backdrop.classList.add('active');
    toggleIcon.style.transform = 'rotate(180deg)';
    // Ne pas bloquer le scroll pour éviter la disparition de la barre
    console.log('Advanced Settings opened');
}

function closeAdvancedSettings() {
    const panel = document.getElementById('advancedPanel');
    const backdrop = document.getElementById('settingsBackdrop');
    const toggleIcon = document.querySelector('.toggle-icon');
    
    panel.classList.remove('expanded');
    backdrop.classList.remove('active');
    toggleIcon.style.transform = 'rotate(0deg)';
    // Pas besoin de restaurer le scroll puisqu'on ne l'a pas bloqué
    console.log('Advanced Settings closed');
}

function saveAdvancedSettings() {
    // Récupérer les valeurs des champs
    const customInstructions = document.querySelector('textarea[name="custom_instructions"]').value;
    const perspective = document.querySelector('select[name="perspective"]').value;
    
    // Afficher un message de confirmation
    showSettingsSavedMessage();
    
    // Fermer la modal
    closeAdvancedSettings();
    
    console.log('Advanced Settings saved:', { customInstructions, perspective });
}

function showSettingsSavedMessage() {
    // Créer un message de confirmation temporaire
    const message = document.createElement('div');
    message.className = 'settings-saved-message';
    message.innerHTML = `
        <i class="fas fa-check-circle"></i>
        Paramètres avancés enregistrés !
    `;
    
    // Ajouter au body
    document.body.appendChild(message);
    
    // Afficher avec animation
    setTimeout(() => {
        message.classList.add('show');
    }, 100);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        message.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(message);
        }, 300);
    }, 3000);
}
</script>

{% endblock %}
