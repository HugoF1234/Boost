{% extends "base.html" %}
{% block content %}

<div class="news-section fade-in">
    <div class="news-header">
        <i class="fa-solid fa-newspaper icon-noble"></i>
        Assistant d'actualitÃ©
    </div>
    <div class="news-subtitle">
        Inspirez vos posts LinkedIn avec les sujets qui font l'actualitÃ© de votre secteur.
    </div>
    <form method="get">
        <div class="news-form-row">
            <div class="news-form-group">
                <label for="keyword">Mot-clÃ©</label>
                <input type="text" id="keyword" name="keyword" class="news-form-control" placeholder="Ex: Intelligence artificielle" value="{{ keyword or '' }}">
            </div>
            <div class="news-form-group">
                <label for="language">Langue</label>
                <select id="language" name="language" class="news-form-control">
                    <option value="fr" {% if language == 'fr' %}selected{% endif %}>ðŸ‡«ðŸ‡· FranÃ§ais</option>
                    <option value="en" {% if language == 'en' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ Anglais</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn-noble"><i class="fas fa-search"></i> Rechercher</button>
            </div>
        </div>
    </form>
    {% if secteur %}
        <div class="news-sector">ðŸ“‚ Secteur dÃ©tectÃ© : <span style="background:var(--noble-mist); border-radius:8px; padding:0.2em 0.7em;">{{ secteur }}</span></div>
    {% endif %}
    {% if error %}
        <div class="news-error">{{ error }}</div>
    {% endif %}

    {% if selected %}
    <div class="news-selected-article">
        <h3>ðŸ“° Article sÃ©lectionnÃ©</h3>
        <p style="font-size:1.1em; font-weight:600;">{{ selected.title }}</p>
        <p style="color:var(--noble-charcoal-light);">{{ selected.description }}</p>
        <a href="{{ selected.url }}" target="_blank" style="color:var(--primary-coral); text-decoration:underline;">Lire l'article complet</a>
    </div>
    {% endif %}

    {% if news %}
    <h2 style="margin-bottom:1em; color:var(--primary-coral); font-size:1.3em; font-weight:700;">RÃ©sultats de recherche</h2>
    <div class="news-articles-grid">
        {% for article in news %}
        <div class="news-article-card">
            {% if article.urlToImage %}
                <img src="{{ article.urlToImage }}" alt="Image de l'article" class="news-article-image" loading="lazy">
            {% else %}
                <div class="news-article-image-placeholder">
                    <i class="fa-regular fa-image"></i>
                </div>
            {% endif %}
            <div class="news-article-content" style="display:flex; flex-direction:column; height:100%; justify-content:space-between;">
                <div>
                    <div class="news-article-title">{{ article.title|clean_html }}</div>
                    <div class="news-article-description">{{ article.description|clean_html }}</div>
                </div>
                <div class="news-article-meta">
                    <span><i class="fa-regular fa-calendar"></i> {{ article.formatted_date }}</span>
                    <span><i class="fa-solid fa-newspaper"></i> {{ article.source.name if article.source.name else article.source }}</span>
                </div>
            </div>
            <div class="news-article-actions">
                <a href="{{ article.url }}" target="_blank" class="btn-glass btn-glass-article">
                    <i class="fas fa-external-link"></i> Lire l'article
                </a>
                <button onclick='selectArticle({{ loop.index0 }})' class="btn-glass btn-glass-use">
                    <i class="fas fa-feather-alt"></i> Utiliser cet article
                </button>
            </div>
            <script type="application/json" class="article-data-{{ loop.index0 }}">
            {
                "title": {{ article.title | tojson }},
                "description": {{ article.description | tojson }},
                "url": {{ article.url | tojson }},
                "source": {{ article.source | tojson }},
                "formatted_date": {{ article.formatted_date | tojson }},
                "urlToImage": {{ article.urlToImage | tojson }}
            }
            </script>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="news-article-card" style="background:var(--noble-mist); text-align:center; color:var(--noble-accent-light); margin-top:2em;">
        <i class="fa-regular fa-newspaper" style="font-size:2.5em;"></i>
        <p style="margin-top:1em; font-size:1.1em;">Aucune actualitÃ© trouvÃ©e pour l'instant.</p>
    </div>
    {% endif %}
</div>
<script>
function selectArticle(index) {
    const json = document.querySelector('.article-data-' + index).textContent;
    fetch('/select_article', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: json
    }).then(response => response.json()).then(() => {
        window.location.href = '/dashboard';
    });
}
</script>
{% endblock %}
