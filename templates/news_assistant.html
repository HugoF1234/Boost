{% extends "base.html" %}
{% block content %}
<div class="container">
  <h1>Assistant d'actualitÃ©</h1>

  <form method="get" class="form-inline" action="{{ url_for('news_assistant') }}">
    <input type="text" name="keyword" placeholder="Mot-clÃ© (facultatif)" value="{{ keyword or '' }}">
    <select name="language">
      <option value="fr" {% if language == 'fr' %}selected{% endif %}>FranÃ§ais</option>
      <option value="en" {% if language == 'en' %}selected{% endif %}>Anglais</option>
    </select>
    <button type="submit">Rechercher</button>
  </form>

  {% if secteur %}
  <p>ðŸ“‚ Secteur dÃ©tectÃ© : <strong>{{ secteur }}</strong></p>
  {% endif %}

  {% if error %}
  <div style="color:red;">Erreur : {{ error }}</div>
  {% endif %}

  {% if selected %}
  <div style="background:#f0f0f0; padding:1em; margin:1em 0;">
    <h3>ðŸ“° Article sÃ©lectionnÃ©</h3>
    <p><strong>{{ selected.title }}</strong></p>
    <p>{{ selected.description }}</p>
    <a href="{{ selected.url }}" target="_blank">Lire lâ€™article complet</a>
  </div>
  {% endif %}

  {% if news %}
  <h2>RÃ©sultats de recherche</h2>
  <ul style="list-style: none; padding: 0;">
    {% for article in news %}
    <li style="margin-bottom: 2em; border-bottom: 1px solid #ccc; padding-bottom: 1em;">
      <h4>{{ article.title }}</h4>
      <p>{{ article.description }}</p>
      <p><small>ðŸ—“ {{ article.formatted_date }} | ðŸ“° {{ article.source }}</small></p>
      <a href="{{ article.url }}" target="_blank">Lire lâ€™article</a>
      <br><br>
      <button onclick='selectArticle({{ loop.index0 }})'>Utiliser cet article</button>
      <script type="application/json" class="article-data-{{ loop.index0 }}">
      {
        "title": {{ article.title | tojson }},
        "description": {{ article.description | tojson }},
        "url": {{ article.url | tojson }},
        "source": {{ article.source | tojson }},
        "formatted_date": {{ article.formatted_date | tojson }},
        "urlToImage": {{ article.urlToImage | tojson }}
      }
      </script>
    </li>
    {% endfor %}
  </ul>
  {% else %}
    <p>Aucune actualitÃ© trouvÃ©e pour lâ€™instant.</p>
  {% endif %}
</div>

<script>
function selectArticle(index) {
  const json = document.querySelector('.article-data-' + index).textContent;
  fetch('/select_article', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: json
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      window.location.href = data.redirect;
    } else {
      alert('Erreur : ' + data.error);
    }
  })
  .catch(err => alert('Erreur rÃ©seau : ' + err));
}
</script>
{% endblock %}
